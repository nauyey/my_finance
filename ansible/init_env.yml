---
- name: Initial Environment Setup - Bootstrap system, install dependencies, Neo4j, and update submodules
  hosts: localhost
  become: yes
  gather_facts: yes
  vars:
    # Neo4j configuration
    neo4j_version: "5.18.0"
    neo4j_tarball: "neo4j-community-{{ neo4j_version }}-unix.tar.gz"
    neo4j_download_url: "https://neo4j.com/artifact.php?name={{ neo4j_tarball }}"
    neo4j_install_dir: "/opt/neo4j"

    # Main repository (my_finance) is assumed to be the current directory.
    branch: "main"

  tasks:
    - name: Set current directory variable using lookup('env', 'PWD')
      set_fact:
        current_dir: "{{ lookup('env', 'PWD') }}"
      become: false

    - name: Debug current directory
      debug:
        msg: "Current directory is {{ current_dir }}"
      become: false

    - name: Check if current repository is a git repository
      stat:
        path: "{{ current_dir }}/.git"
      register: main_repo_stat
      become: false

    - name: Fail if current directory is not a git repository
      fail:
        msg: "This playbook must be executed inside the my_finance repository directory. Current directory: {{ current_dir }}"
      when: not main_repo_stat.stat.exists
      become: false

    # -------------------------
    # System and Neo4j setup
    # -------------------------
    - name: Update APT cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install essential system packages (Python3 and pip3)
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - python3
        - python3-pip

    - name: Install OpenJDK 17
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Create Neo4j installation directory
      file:
        path: "{{ neo4j_install_dir }}"
        state: directory

    - name: Download Neo4j tarball
      get_url:
        url: "{{ neo4j_download_url }}"
        dest: "/tmp/{{ neo4j_tarball }}"
        mode: '0644'

    - name: Extract Neo4j tarball to installation directory
      unarchive:
        src: "/tmp/{{ neo4j_tarball }}"
        dest: "{{ neo4j_install_dir }}"
        remote_src: yes
        extra_opts: [--strip-components=1]

    - name: Configure Neo4j to listen on 0.0.0.0
      lineinfile:
        path: "{{ neo4j_install_dir }}/conf/neo4j.conf"
        regexp: '^#?dbms\.default_listen_address='
        line: 'dbms.default_listen_address=0.0.0.0'
        state: present

    - name: Start Neo4j service
      command: "{{ neo4j_install_dir }}/bin/neo4j start"
      register: neo4j_start
      failed_when: (neo4j_start.rc != 0) and ("Neo4j is already running" not in neo4j_start.stderr)

    - name: Check Neo4j service status
      command: "{{ neo4j_install_dir }}/bin/neo4j status"
      register: neo4j_status
      changed_when: false

    - name: Display Neo4j service status
      debug:
        var: neo4j_status.stdout_lines

    # -------------------------
    # Update submodules (data repository)
    # -------------------------
    - name: Update git submodules (data) in my_finance
      command: git submodule update --init --recursive
      args:
        chdir: "{{ current_dir }}"
      become: false

    # -------------------------
    # Install pipenv dependencies
    # -------------------------
    - name: Install pipenv dependencies (creates virtual environment)
      command: pipenv install
      args:
        chdir: "{{ current_dir }}"
      become: false

    - name: Final message
      debug:
        msg: "Initial environment setup complete. Verify Neo4j at http://localhost:7474."
      become: false
